name: App CI/CD
on:
  push:
    branches: ["main", "staging", "dev"]
    paths: ["app/**", ".github/workflows/app-ci-cd.yml"]
env:
  AWS_REGION: ap-southeast-2
  PROJECT: clinic-microservices

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [patient-service, appointment-service]
    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_APP_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      - uses: aws-actions/amazon-ecr-login@v2

      - name: Set repo URLs
        id: repos
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          if [ "${{ matrix.service }}" = "patient-service" ]; then
            REPO="${ACCOUNT_ID}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.PROJECT }}-patient";
          else
            REPO="${ACCOUNT_ID}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.PROJECT }}-appointment";
          fi
          echo "repo=$REPO" >> $GITHUB_OUTPUT
          echo "tag=${GITHUB_SHA}" >> $GITHUB_OUTPUT

      - name: Build image
        working-directory: app/${{ matrix.service }}
        run: docker build -t ${{ steps.repos.outputs.repo }}:${{ steps.repos.outputs.tag }} .

      - name: Push SHA tag
        run: docker push ${{ steps.repos.outputs.repo }}:${{ steps.repos.outputs.tag }}

      - name: Tag latest (for Terraform task defs)
        run: |
          docker tag ${{ steps.repos.outputs.repo }}:${{ steps.repos.outputs.tag }} ${{ steps.repos.outputs.repo }}:latest
          docker push ${{ steps.repos.outputs.repo }}:latest

  deploy-ecs:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_APP_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      - name: Force new deployment of services
        run: |
          CLUSTER="${{ env.PROJECT }}-cluster"
          for svc in "${{ env.PROJECT }}-patient" "${{ env.PROJECT }}-appointment"; do
            aws ecs update-service --cluster "$CLUSTER" --service "$svc" --force-new-deployment >/dev/null
            echo "Deployment triggered for $svc"
          done
